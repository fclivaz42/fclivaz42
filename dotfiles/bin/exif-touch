#!/bin/bash
timestamp()
{
	ts=$(exiftool -T -CreateDate "$1" 2>/dev/null)
	if [[ ! "$ts" == "0000:00:00 00:00:00" ]] && [[ ! "$ts" == "-" ]]; then
		ts=${ts/:/-}
		ts=${ts/:/-}
		echo "$ts"
	elif echo "$1" | grep -E -o -q "20[0-2][0-9][-_:. ]?[0-1][0-9][-_:. ]?[0-3][0-9][-_ .]?[0-2][0-9][-_: .]?[0-5][0-9][-_: .]?[0-5][0-9]"; then
		echo "$1" | grep -E -o "20[0-2][0-9][-_:. ]?[0-1][0-9][-_:. ]?[0-3][0-9][-_ .]?[0-2][0-9][-_: .]?[0-5][0-9][-_: .]?[0-5][0-9]" | sed -E 's/20([0-2][0-9])[-_:. ]?([0-1][0-9])[-_:. ]?([0-3][0-9])[-_ .]?([0-2][0-9])[-_: .]?([0-5][0-9])[-_: .]?([0-5][0-9])/20\1-\2-\3 \4:\5:\6/g'
	elif echo "$1" | grep -E -o -q "20[0-2][0-9][-_:. ]?[0-1][0-9][-_:. ]?[0-3][0-9]"; then
		echo "$1" | grep -E -o "20[0-2][0-9][-_:. ]?[0-1][0-9][-_:. ]?[0-3][0-9]" | sed -E 's/20([0-2][0-9])[-_:. ]?([0-1][0-9])[-_:. ]?([0-3][0-9])/20\1-\2-\3/g'
	else
		if [[ "$1" =~ "Memedroid" ]]; then
			echo "2016-01-01"
		elif [[ "$1" =~ "Reddit" ]]; then
			echo "2017-01-01"
		elif [[ "$1" =~ "OC refs" ]]; then
			echo "2023-01-01"
		elif [[ "$1" =~ "kool things" ]]; then
			echo "2024-01-01"
		else
			echo "2020-01-01"
		fi
	fi
}

export -f timestamp

handle_video()
{
	if [[ $(($(wc -c "$1" | cut -f1 -d' ') / 1000000)) -gt 100 ]] && [[ ! "$1" =~ "WhatsApp" ]]; then
		ts=$(timestamp "$1")
		echo "$1 bigger than 100M, compressing"
		name="$(echo "$1" | sed 's/.mp4//g')_c.mp4"
		ffmpeg_code=0
		ffmpeg -hwaccel vaapi -hwaccel_output_format vaapi -vaapi_device /dev/dri/renderD128 -i "$1" -c:v h264_vaapi -crf 23 -preset veryslow -c:a copy "$name" || ffmpeg_code=1
		[[ $(wc -c "$name" | cut -f1 -d' ') -lt $(wc -c "$1" | cut -f1 -d' ') ]] || ffmpeg_code=2
		if [[ $ffmpeg_code -eq 0 ]]; then
			rm -rf "$1"
		else
			rm -rf "$name"
			mv "$1" "$name"
			[[ $ffmpeg_code -eq 1 ]] && echo "FFMPEG fail for $1!"
			[[ $ffmpeg_code -eq 2 ]] && echo "$name bigger than $1, cancelling"
		fi
		touch -d "$ts" "$name"
		tsv=$(exiftool -T -CreateDate "$name" 2>/dev/null)
		if [[ "$tsv" == "0000:00:00 00:00:00" ]]; then
			exiftool -delete_original "-DateTimeOriginal<FileModifyDate" "-CreateDate<FileModifyDate" "$name"
			touch -d "$ts" "$name"
			echo "Updated exif $ts for $1"
		fi
		echo "$ts $name"
	else
		handle_picture "$1"
	fi
}

handle_picture()
{
	ts=$(timestamp "$1")
	tso=$(exiftool -T -CreateDate "$1" 2>/dev/null)
	touch -d "$ts" "$1"
	if [[ "$tso" == "0000:00:00 00:00:00" ]] || [[ "$tso" == "-" ]]; then
		exiftool -delete_original "-DateTimeOriginal<FileModifyDate" "-CreateDate<FileModifyDate" "$1" &>/dev/null
		touch -d "$ts" "$1"
		echo "Updated exif $ts for $1"
	fi
	echo "$ts $1"
}

export -f handle_video
export -f handle_picture

find . -path "./DCIM" -prune -o -type f -name "*.mp4" -exec bash -c "handle_video \"{}\"" \; &
find "./DCIM" -type f -name "*.mp4" -exec bash -c "handle_video \"{}\"" \; &
find . -type f -name "*.MP4" -exec bash -c "handle_video \"{}\"" \; &
find . -type f -name "*.mov" -exec bash -c "handle_video \"{}\"" \; &
find . -type f -name "*.MOV" -exec bash -c "handle_video \"{}\"" \; &
find . \( -path "./DCIM" -o -path "./Android/media/com.whatsapp/WhatsApp/Media" \) -prune -o -type f -name "*.jpg" -exec bash -c "handle_picture \"{}\"" \; &
find . \( -path "./DCIM" -o -path "./Android/media/com.whatsapp/WhatsApp/Media" \) -prune -o -type f -name "*.jpeg" -exec bash -c "handle_picture \"{}\"" \; &
find "./DCIM" -type f -name "*.jpg" -exec bash -c "handle_picture \"{}\"" \; &
find "./DCIM" -type f -name "*.jpeg" -exec bash -c "handle_picture \"{}\"" \; &
find "./Android/media/com.whatsapp/WhatsApp/Media" -type f -name "*.jpg" -exec bash -c "handle_picture \"{}\"" \; &
find "./Android/media/com.whatsapp/WhatsApp/Media" -type f -name "*.jpeg" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.JPG" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.JPEG" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.jfif" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.JFIF" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.png" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.PNG" -exec bash -c "handle_picture \"{}\"" \; &
find . -type f -name "*.gif" -exec touch -d '2019-01-01' '{}' \;
